# Chaos Mesh å…¥é—¨æ•™ç¨‹

**æ··æ²Œå·¥ç¨‹æ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸Šè¿›è¡Œå®éªŒçš„å­¦ç§‘ï¼Œç›®çš„æ˜¯å»ºç«‹å¯¹ç³»ç»ŸæŠµå¾¡ç”Ÿäº§ç¯å¢ƒä¸­å¤±æ§æ¡ä»¶çš„èƒ½åŠ›ä»¥åŠä¿¡å¿ƒã€‚**


å³ä½¿åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ‰€æœ‰å•ä¸ªæœåŠ¡éƒ½æ­£å¸¸è¿è¡Œ, è¿™äº›æœåŠ¡ä¹‹é—´çš„äº¤äº’ä¹Ÿä¼šå¯¼è‡´ä¸å¯é¢„çŸ¥çš„ç»“æœã€‚è¿™äº›ä¸å¯é¢„çŸ¥çš„ç»“æœ, ç”±å½±å“ç”Ÿäº§ç¯å¢ƒçš„ç½•è§ä¸”ç ´åæ€§çš„äº‹ä»¶å¤åˆè€Œæˆï¼Œä»¤è¿™äº›åˆ†å¸ƒå¼ç³»ç»Ÿå­˜åœ¨å†…åœ¨çš„æ··æ²Œã€‚

æˆ‘ä»¬éœ€è¦åœ¨å¼‚å¸¸è¡Œä¸ºå‡ºç°ä¹‹å‰ï¼Œåœ¨æ•´ä¸ªç³»ç»Ÿå†…æ‰¾å‡ºè¿™äº›å¼±ç‚¹ã€‚è¿™äº›å¼±ç‚¹åŒ…æ‹¬ä»¥ä¸‹å½¢å¼:


* **å½“æœåŠ¡ä¸å¯ç”¨æ—¶çš„ä¸æ­£ç¡®å›æ»šè®¾ç½®;**
* **ä¸å½“çš„è¶…æ—¶è®¾ç½®å¯¼è‡´çš„é‡è¯•é£æš´;**
* **ç”±äºä¸‹æ¸¸ä¾èµ–çš„æµé‡è¿‡è½½å¯¼è‡´çš„æœåŠ¡ä¸­æ–­;**
* **å•ç‚¹æ•…éšœæ—¶çš„çº§è”å¤±è´¥ç­‰**ã€‚

æˆ‘ä»¬é‡‡ç”¨åŸºäºç»éªŒå’Œç³»ç»Ÿçš„æ–¹æ³•è§£å†³äº†åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨è§„æ¨¡å¢é•¿æ—¶å¼•å‘çš„é—®é¢˜ï¼Œå¹¶ä»¥æ­¤å»ºç«‹å¯¹ç³»ç»ŸæŠµå¾¡è¿™äº›äº‹ä»¶çš„èƒ½åŠ›å’Œä¿¡å¿ƒï¼Œé€šè¿‡åœ¨å—æ§å®éªŒä¸­è§‚å¯Ÿåˆ†å¸ƒå¼ç³»ç»Ÿçš„è¡Œä¸ºæ¥äº†è§£å®ƒçš„ç‰¹æ€§ï¼Œ**æˆ‘ä»¬ç§°ä¹‹ä¸ºæ··æ²Œå·¥ç¨‹ã€‚**

## ä»€ä¹ˆæ˜¯ Chaos Mesh?

Chaos MeshÂ®æ˜¯äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼šï¼ˆCNCFï¼‰æ‰˜ç®¡çš„é¡¹ç›®ã€‚

Chaos Mesh æ˜¯ä¸€ä¸ªé€šç”¨çš„æ··æ²Œå·¥ç¨‹è§£å†³æ–¹æ¡ˆï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯å¯¹Kubernetes ä¸Šçš„å¤æ‚ç³»ç»Ÿè¿›è¡Œå…¨æ–¹ä½çš„**æ•…éšœæ³¨å…¥æ–¹æ³•ï¼Œæ¶µç›–äº† Podã€ç½‘ç»œã€æ–‡ä»¶ç³»ç»Ÿç”šè‡³å†…æ ¸çš„æ•…éšœã€‚Chaos Mesh ä¸»è¦åŒ…æ‹¬ä¸‹é¢ä¸¤ä¸ªç»„ä»¶ï¼š**

* **Chaos Operatorï¼šæ··æ²Œç¼–æ’çš„æ ¸å¿ƒç»„ä»¶ã€‚**
* **Chaos Dashboardï¼šç”¨äºç®¡ç†ã€è®¾è®¡ã€ç›‘æ§æ··æ²Œå®éªŒçš„ Web UIã€‚**

`Chaos Mesh` ä½¿ç”¨ `CRD` æ¥å®šä¹‰æ··æ²Œå¯¹è±¡ã€‚

`Chaos Mesh` çš„æ•´ä½“æ¶æ„éå¸¸ç®€å•ï¼Œç»„ä»¶éƒ¨ç½²åœ¨ Kubernetes ä¹‹ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ YAML æ–‡ä»¶æˆ–è€…ä½¿ç”¨ `Chaos mesh Dashboard` ä¸Šçš„ `Form` æ¥æŒ‡å®šåœºæ™¯ã€‚

**å…¶ä¸­ä¼šæœ‰ä¸€ä¸ª `Chaos Daemon`ï¼Œä»¥ `Daemonset` çš„å½¢å¼è¿è¡Œï¼Œå¯¹ç‰¹å®šèŠ‚ç‚¹çš„ç½‘ç»œã€Cgroup ç­‰å…·æœ‰ç³»ç»Ÿæƒé™**ã€‚


![Alt Image Text](images/2_1.png "Body image")

ç›®å‰å®ç°çš„ CRD å¯¹è±¡æ”¯æŒ6ç§ç±»å‹çš„æ•…éšœæ³¨å…¥ï¼Œåˆ†åˆ«æ˜¯ **PodChaosã€NetworkChaosã€IOChaosã€TimeChaosã€StressChaos å’Œ KernelChaos**ï¼Œå¯¹åº”çš„ä¸»è¦åŠ¨ä½œå¦‚ä¸‹æ‰€ç¤ºï¼š

* `pod-kill`ï¼šæ¨¡æ‹Ÿ Kubernetes Pod è¢« killã€‚
* `pod-failure`ï¼šæ¨¡æ‹Ÿ Kubernetes Pod æŒç»­ä¸å¯ç”¨ï¼Œå¯ä»¥ç”¨æ¥æ¨¡æ‹ŸèŠ‚ç‚¹å®•æœºä¸å¯ç”¨åœºæ™¯ã€‚
* `network-delay`ï¼šæ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿã€‚
* `network-loss`ï¼šæ¨¡æ‹Ÿç½‘ç»œä¸¢åŒ…ã€‚
* `network-duplication`: æ¨¡æ‹Ÿç½‘ç»œåŒ…é‡å¤ã€‚
* `network-corrupt`: æ¨¡æ‹Ÿç½‘ç»œåŒ…æŸåã€‚
* `network-partition`ï¼šæ¨¡æ‹Ÿç½‘ç»œåˆ†åŒºã€‚
* `I/O delay` : æ¨¡æ‹Ÿæ–‡ä»¶ç³»ç»Ÿ I/O å»¶è¿Ÿã€‚
* `I/O errno`ï¼šæ¨¡æ‹Ÿæ–‡ä»¶ç³»ç»Ÿ I/O é”™è¯¯ ã€‚

### å®‰è£…

æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨ `Kubernetes` é›†ç¾¤ä¸Šå¾ˆæ–¹ä¾¿åœ°å®‰è£… `Chaos Mesh`ï¼Œè¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨è½»é‡çº§çš„ `Kind` æ­å»ºçš„ `Kubernetes` é›†ç¾¤ã€‚å½“ç„¶åœ¨éƒ¨ç½²ä¹‹å‰ï¼Œå…ˆç¡®ä¿ `Docker` å·²åœ¨æœ¬åœ°æœºå™¨ä¸Šå®‰è£…å¹¶è¿è¡Œã€‚

```
$ curl -sSL https://mirrors.chaos-mesh.org/v1.0.1/install.sh | bash
```

**ä¸Šé¢çš„å‘½ä»¤ä¼šå®‰è£…æ‰€æœ‰çš„ `CRD`ã€`ServiceAccount` å’Œæ‰€æœ‰ç»„ä»¶ï¼Œå¦‚æœä½ ä½¿ç”¨çš„æ˜¯ `k3s `æˆ– `k3d`ï¼Œéœ€è¦æŒ‡å®š kind å‚æ•°ã€‚**

```
$ curl -sSL https://mirrors.chaos-mesh.org/v1.0.1/install.sh | bash -s â€”-local kind
```

å¦‚æœä½ å·²ç»å®‰è£…äº†å¤§äº 0.7 ç‰ˆæœ¬çš„Kindï¼Œé‚£ä¹ˆè„šæœ¬å°†ç»§ç»­ï¼Œå¦åˆ™å°†å®‰è£…ä¸€ä¸ªæ–°çš„ç‰ˆæœ¬ã€‚è„šæœ¬è¿è¡Œåçš„è¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```
Install kubectl client
kubectl Version 1.18.8 has been installed
Install Kind tool
Kind Version 0.8.1 has been installed
Install local Kubernetes kind
No kind clusters found.
Clean data dir: /Users/rbanka/kind/kind/data
start to create kubernetes cluster kindCreating cluster "kind" ...
DEBUG: docker/images.go:58] Image: kindest/node:v1.17.2 present locally
 âœ“ Ensuring node image (kindest/node:v1.17.2) ğŸ–¼
 âœ“ Preparing nodes ğŸ“¦ ğŸ“¦ ğŸ“¦ ğŸ“¦
 âœ“ Writing configuration ğŸ“œ
 âœ“ Starting control-plane ğŸ•¹ï¸
 âœ“ Installing CNI ğŸ”Œ
 âœ“ Installing StorageClass ğŸ’¾
 âœ“ Joining worker nodes ğŸšœ
Set kubectl context to "kind-kind"
You can now use your cluster with:
kubectl cluster-info --context kind-kind
Thanks for using kind! ğŸ˜Š
Install Chaos Mesh chaos-mesh
customresourcedefinition.apiextensions.k8s.io/iochaos.chaos-mesh.org created
customresourcedefinition.apiextensions.k8s.io/kernelchaos.chaos-mesh.org created
customresourcedefinition.apiextensions.k8s.io/networkchaos.chaos-mesh.org created
customresourcedefinition.apiextensions.k8s.io/podchaos.chaos-mesh.org created
customresourcedefinition.apiextensions.k8s.io/podiochaos.chaos-mesh.org created
customresourcedefinition.apiextensions.k8s.io/podnetworkchaos.chaos-mesh.org created
customresourcedefinition.apiextensions.k8s.io/stresschaos.chaos-mesh.org created
customresourcedefinition.apiextensions.k8s.io/timechaos.chaos-mesh.org created
namespace/chaos-testing created
serviceaccount/chaos-controller-manager created
secret/chaos-mesh-webhook-certs created
clusterrole.rbac.authorization.k8s.io/chaos-mesh:chaos-controller-manager-target-namespace created
clusterrole.rbac.authorization.k8s.io/chaos-mesh:chaos-controller-manager-cluster-level created
clusterrolebinding.rbac.authorization.k8s.io/chaos-mesh:chaos-controller-manager-cluster-level created
clusterrolebinding.rbac.authorization.k8s.io/chaos-mesh:chaos-controller-manager-target-namespace created
role.rbac.authorization.k8s.io/chaos-mesh:chaos-controller-manager-control-plane created
rolebinding.rbac.authorization.k8s.io/chaos-mesh:chaos-controller-manager-control-plane created
service/chaos-dashboard created
service/chaos-mesh-controller-manager created
daemonset.apps/chaos-daemon created
deployment.apps/chaos-dashboard created
deployment.apps/chaos-controller-manager created
mutatingwebhookconfiguration.admissionregistration.k8s.io/chaos-mesh-mutation created
validatingwebhookconfiguration.admissionregistration.k8s.io/chaos-mesh-validation created
Waiting for pod running
chaos-controller-manager-754d4f7585-h9p4c   0/1   ContainerCreating   0     10s
Waiting for pod running
chaos-controller-manager-754d4f7585-h9p4c   0/1   ContainerCreating   0     21s
Waiting for pod running
chaos-controller-manager-754d4f7585-h9p4c   0/1   ContainerCreating   0     31s
Waiting for pod running
Chaos Mesh chaos-mesh is installed successfully
```

è¦éªŒè¯ç»„ä»¶æ˜¯å¦åœ¨ Kubernetes Cluster ä¸Šè¿è¡ŒæˆåŠŸï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•æ£€æŸ¥ã€‚

```
$ kubectl get pod -n chaos-testing
NAME                                        READY   STATUS    RESTARTS   AGE
chaos-controller-manager-86c96f985f-bhtj8   1/1     Running   0          3h33m
chaos-daemon-rhv22                          1/1     Running   0          3h33m
chaos-dashboard-5d8dff7df9-6zgkc            1/1     Running   0          3h33m
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ‰3ä¸ªç»„ä»¶å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œcontrollerã€dashboard ä»¥åŠä½œä¸º Daemonset çš„è¿è¡Œæ··æ²Œ daemon è¿›ç¨‹ã€‚æ¥ç€æ£€æŸ¥ä¸‹ CRD æ˜¯å¦åœ¨é›†ç¾¤ä¸Šåˆ›å»ºæˆåŠŸã€‚

```
$ kubectl get crds | grep chaos
iochaos.chaos-mesh.org                  2020-10-30T02:51:54Z
kernelchaos.chaos-mesh.org              2020-10-30T02:51:54Z
networkchaos.chaos-mesh.org             2020-10-30T02:51:54Z
podchaos.chaos-mesh.org                 2020-10-30T02:51:54Z
podiochaos.chaos-mesh.org               2020-10-30T02:51:54Z
podnetworkchaos.chaos-mesh.org          2020-10-30T02:51:54Z
stresschaos.chaos-mesh.org              2020-10-30T02:51:54Z
timechaos.chaos-mesh.org                2020-10-30T02:51:54Z
```

è¿™äº› CRD å°±ä»£è¡¨äº†ä¸Šé¢è¯¦ç»†æåˆ°çš„å„ç§æ•…éšœæ³¨å…¥çš„ä½¿ç”¨å¯¹è±¡ã€‚

è¦è®¿é—® `Dashboard`ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ `kube-proxy`ï¼Œæˆ–è€…ä½ å¯ä»¥ç›´æ¥åœ¨`Loadbalance`r ä¸Šæš´éœ²å®ƒã€‚æ˜¾ç¤ºè·å– `Chaos mesh Dashbaord `ä¸Šçš„å®¹å™¨ç«¯å£ã€‚

```
$ kubectl get deploy chaos-dashboard -n chaos-testing -o=jsonpath="{.spec.template.spec.containers[0].ports[0].containerPort}{'\n'}"
2333
```

è¾“å‡ºæ˜¾ç¤º Dashboard æ­£åœ¨ç›‘å¬çš„ç«¯å£ã€‚ç„¶åç´§æ¥ç€æˆ‘ä»¬æŠŠæœ¬åœ°ç«¯å£è½¬å‘åˆ° Pod ä¸Šçš„ç«¯å£ï¼Œæˆ‘ä»¬å¯ä»¥ä»ä¸Šé¢å¾—åˆ° pod åç§°å¾—åˆ° pod è¾“å‡ºã€‚

```
$ kubectl get svc -n chaos-testing
NAME                            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                       AGE
chaos-dashboard                 NodePort    10.100.239.125   <none>        2333:31376/TCP                17h
chaos-mesh-controller-manager   ClusterIP   10.110.152.78    <none>        10081/TCP,10080/TCP,443/TCP   17h
```

ç°åœ¨æˆ‘ä»¬å¯ä»¥é€šè¿‡ `http://localhost:31376` è®¿é—® Dashboard äº†ã€‚ä» Dashboard ä¸Šå¯ä»¥çœ‹åˆ°ï¼Œç›®å‰æˆ‘ä»¬è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•å®éªŒã€‚

![Alt Image Text](images/2_2.png "Body image")

> åˆ›å»ºæ··æ²Œå®éªŒ

è¿™é‡Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæµ‹è¯•åœºæ™¯ï¼Œåœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å°†ä¸ºä¸€ä¸ªå‘½åç©ºé—´ä¸­çš„ Pod é…ç½® Chaosï¼Œå®ƒå°†è¢«å®‰æ’æ¯1åˆ†é’Ÿæ€æ­»ä¸€ä¸ª Podã€‚

**æœ¬ä¾‹ä¸­ App æ²¡æœ‰æ ‡ç­¾é€‰æ‹©å™¨ï¼Œæ‰€ä»¥åœ¨å¤šå‰¯æœ¬éƒ¨ç½²çš„æƒ…å†µä¸‹ï¼Œå®ƒå¯ä»¥æ€æ­»ä»»ä½• Podã€‚æˆ‘ä»¬å¯ä»¥åœ¨é…ç½®ä¸­æ‹¥æœ‰ä¸åŒçš„ä½œç”¨åŸŸã€‚**

é¦–å…ˆè®©æˆ‘ä»¬å…‹éš†æˆ‘ä»¬çš„ç¤ºä¾‹ä»“åº“æ¥è·å¾— YAML èµ„æºæ¸…å•æ–‡ä»¶ã€‚

```
$ git clone https://github.com/ronakbanka/chaos-mesh-examples.git
cd chaos-mesh-examples/pod-chaos
```

ç„¶åä½¿ç”¨ Kubectl åº”ç”¨å‘½åç©ºé—´é€‰æ‹©å™¨å®šä¹‰çš„æ–‡ä»¶ï¼Œè¿™å°†åˆ›å»º3ä¸ªèµ„æºå¯¹è±¡ã€‚

```
$ kubectl apply -f pod-namespace-selector.yml
namespace/appns created
deployment.apps/nginx created
podchaos.chaos-mesh.org/pod-kill-example created
```

ç°åœ¨æˆ‘ä»¬åˆ‡æ¢åˆ° `Chaos Mesh Dashboard `ä¸ŠéªŒè¯è¿™ä¸ªå®éªŒï¼Œä½¿ç”¨ä¸Šé¢åŒæ ·çš„æ­¥éª¤è¿›å…¥ã€‚

![Alt Image Text](images/2_3.png "Body image")

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®éªŒå·²ç»è¢«åˆ›å»ºäº†ï¼Œç‚¹å‡» pod-kill-example æ—è¾¹çš„ DETAIL æŒ‰é’®å¯ä»¥æ¥è·å–æˆ‘ä»¬å®éªŒçš„è¯¦ç»†ä¿¡æ¯ã€‚

![Alt Image Text](images/2_4.png "Body image")

è¯¦ç»†å†…å®¹åŸºæœ¬ä¸Šå’Œæˆ‘ä»¬çš„ YAML æ–‡ä»¶ä¸­çš„ PodChaos å¯¹è±¡æè¿°æ˜¯ä¸€æ ·çš„ã€‚

```
---
apiVersion: chaos-mesh.org/v1alpha1
kind: PodChaos
metadata:
  name: pod-kill-example
  namespace: chaos-testing
spec:
  action: pod-kill
  mode: one
  selector:
    namespaces:
      - appns
  scheduler:
    cron: "@every 1m"
```

ç°åœ¨ï¼Œè®©æˆ‘ä»¬åœ¨ç»ˆç«¯ä¸Šä½¿ç”¨ kubectl æ¥éªŒè¯ pod æ•…éšœï¼š

* åˆå§‹åŒ–çŠ¶æ€

```
$ kubectl get pods -n appns -w
NAME                     READY   STATUS    RESTARTS   AGE
nginx-86c57db685-57l8j   1/1     Running   0          7s
nginx-86c57db685-mf2m9   1/1     Running   0          5m7s
nginx-86c57db685-szvqx   1/1     Running   0          3m7s
```

* ä¸­é—´çŠ¶æ€

```
$ kubectl get pod -n appns  -w
NAME                    READY   STATUS              RESTARTS   AGE
nginx-f89759699-6zsfj   0/1     ContainerCreating   0          2s
nginx-f89759699-7hcq4   1/1     Running             0          5m2s
nginx-f89759699-n46p4   1/1     Running             0          62s
nginx-f89759699-6zsfj   1/1     Running             0          7s
nginx-f89759699-n46p4   1/1     Terminating         0          2m
nginx-f89759699-n46p4   1/1     Terminating         0          2m
nginx-f89759699-cf7w9   0/1     Pending             0          0s
nginx-f89759699-cf7w9   0/1     Pending             0          0s
nginx-f89759699-cf7w9   0/1     ContainerCreating   0          0s
nginx-f89759699-cf7w9   1/1     Running             0          7s
```

æœ€ç»ˆçŠ¶æ€

```
$ kubectl get pods -n appns
NAME                    READY   STATUS    RESTARTS   AGE
nginx-f89759699-l747h   1/1     Running   0          16h
nginx-f89759699-p55mh   1/1     Running   0          16h
nginx-f89759699-zxkhp   1/1     Running   0          16h
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ­¤æ—¶æœ‰2ä¸ª Pod è¢«é‡æ–°åˆ›å»ºï¼Œå¦å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åœ¨å®éªŒè¯¦æƒ…ä¸‹æŸ¥çœ‹ Chaos Mesh Dashboard ä¸Šçš„äº‹ä»¶ã€‚


![Alt Image Text](images/2_5.png "Body image")

å®éªŒå®Œæˆåæˆ‘ä»¬å¯ä»¥æ‰§è¡Œä¸‹é¢çš„æ­¥éª¤æ¥æ¸…ç†å¸è½½ç»„ä»¶ï¼Œä¹ŸåŒ…æ‹¬ kind åˆ›å»ºçš„é›†ç¾¤ã€‚

```
$ kubectl delete ns chaos-testing
$ kind delete cluster --name=kind
```

æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ Chaos Mesh åˆ›å»ºå„ç§å„æ ·çš„æ•…éšœåœºæ™¯ï¼Œåé¢æˆ‘ä»¬å†åˆ†åˆ«ä»‹ç»ä¸€äº›å…¶ä»–åœºæ™¯ã€‚

